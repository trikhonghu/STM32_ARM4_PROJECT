/*
 * fsm.c
 *
 *  Created on: Nov 28, 2023
 *      Author: Admin
 */


#include "fsm.h"

int status = INIT;
int ID = 0;
int mode = EASY;
int speed = 1000;
int check_sent;
int count = 0;
//uint8_t count_adc = 0;

void fsm_mode(){
	switch(mode){
	case EASY:
		speed = 1000;
		break;
	case AVERAGE:
		speed = 100;
		break;
	case HARD:
		speed = 10;
		break;
	}
}

void enter_ID(){
	if(button_count[0] == 1)
		ID = ID*10+1;
	if(button_count[1] == 1)
		ID = ID*10+2;
	if(button_count[2] == 1)
		ID = ID*10+3;
	if(button_count[4] == 1)
		ID = ID*10+4;
	if(button_count[5] == 1)
		ID = ID*10+5;
	if(button_count[6] == 1)
		ID = ID*10+6;
	if(button_count[8] == 1)
		ID = ID*10+7;
	if(button_count[9] == 1)
		ID = ID*10+8;
	if(button_count[10] == 1)
		ID = ID*10+9;
	if(button_count[13] == 1)
		ID = ID*10;
	if(ID > 9999)
		ID = ID % 10;
}

void change_mode(){
	if(button_count[12] == 1){
		lcd_Clear(BLACK);
		status = INIT;
		return;
	}
	lcd_ShowStr(0, 10, "1. EASY", WHITE, BLACK, 16, 0);
	lcd_ShowStr(0, 30, "2. MEDIUM", WHITE, BLACK, 16, 0);
	lcd_ShowStr(0, 50, "3. HARD", WHITE, BLACK, 16, 0);
	lcd_ShowStr(0, 70, "4. THEM MOT MODE DI BA`", WHITE, BLACK, 16, 0);
	lcd_ShowStr(0, 90, "E. EXIT", WHITE, BLACK, 16, 0);

	if(button_count[0] == 1){
		mode = EASY;
		lcd_Clear(BLACK);
		status = INIT;
	}
	if(button_count[1] == 1){
		mode = AVERAGE;
		lcd_Clear(BLACK);
		status = INIT;
	}
	if(button_count[2] == 1){
		mode = HARD;
		lcd_Clear(BLACK);
		status = INIT;
	}
}

void fsm_machine(){
	switch (status) {
	case CHANGE_MODE:
		change_mode();
		break;
	case INIT:
		screen_init();
		enter_ID();
		//test_Adc();

		if(button_count[14] == 1){
			lcd_Clear(BLACK);
			status = CHANGE_MODE;
			char sec = '/';
			char res[10];
			sprintf(res, "%d%c", ID, sec);
			uart_EspSendString(res);
			//uart_EspSendNum(ID);
			//uart_EspSendString("/");
		}

		if(isButtonStart()){
			status = PLAY;
			count = 0;
			lcd_Clear(BLACK);
			re_init();
			screen_play();
			fsm_mode();
			setTimer4(1000);
		}
		break;
	case PLAY:
		if(flag_timer4 == 1){
			setTimer4(1000);
			count++;
			led7_SetDigit((count%60)%10, 3, 0);
			led7_SetDigit((count%60)/10, 2, 0);
			led7_SetDigit((count/60)%10, 1, 0);
			led7_SetDigit((count/60)/10, 0, 0);
		}
		if(isButtonUp()){
			sw_up = 0;
			sw_down = 1;
			sw_left = 1;
			sw_right = 1;
			//flag_timer3 = 1;
		}
		if(isButtonDown()){
			sw_up = 1;
			sw_down = 0;
			sw_left = 1;
			sw_right = 1;
			//flag_timer3 = 1;
		}
		if(isButtonLeft()){
			sw_up = 1;
			sw_down = 1;
			sw_left = 0;
			sw_right = 1;
			//flag_timer3 = 1;
		}
		if(isButtonRight()){
			sw_up = 1;
			sw_down = 1;
			sw_left = 1;
			sw_right = 0;
			//flag_timer3 = 1;
		}
		wait_check();
		if(flag_timer3 == 1){
			//wait_check();
			setTimer3(speed);
			update_grid();
			check_food();
			move_snake();
			check_collision();
			screen_score();
		}
		if(lose == 1){
			status = GAME_OVER;
			lcd_Clear(BLACK);
			lose = 0;
		}
		break;
	case GAME_OVER:
		enter_ID();
		screen_game_over();
		if(button_count[14] == 1){
			lcd_Clear(BLACK);
			status = CHANGE_MODE;
		}

		if(isButtonRestart()){
//			status = INIT;
//			lcd_Clear(BLACK);
//			re_init();
			count = 0;
			status = PLAY;
			lcd_Clear(BLACK);
			re_init();
			screen_play();
			fsm_mode();
		}
		break;
	default:
		break;
	}
}


